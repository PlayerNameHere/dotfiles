name: Deploy

on:
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-22.04
    steps:
      - id: download-spec
        uses: dawidd6/action-download-artifact@v2
        with:
          name: deploy-spec-${{ github.sha }}
          workflow: build.yml
          commit: ${{ github.sha }}
          workflow_conclusion: "completed"
          search_artifacts: true
          if_no_artifact_found: ignore
      - if: ${{ !steps.download-spec.outputs.found_artifact }}
        uses: actions/checkout@v3
      - if: ${{ !steps.download-spec.outputs.found_artifact }}
        uses: ./.github/actions/build
        with:  # TODO: find a way to reuse the definition from `build.yml`
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          flake-output: "cachix-deploy-spec"
          cachix-extra-pull-names: "nix-gaming, hyprland, nix-community"
          cachix-skip-push: true
          upload-artifact: true
          artifact-name: deploy-spec-${{ github.sha }}
      - name: Deploy
        env:
          CACHIX_ACTIVATE_TOKEN: "${{ secrets.CACHIX_ACTIVATE_TOKEN }}"
        run: |
          cachix push playernamehere-nixos ./result
          cachix deploy activate ./result
